<!DOCTYPE HTML>
<!--
	Phantom by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Phantom by HTML5 UP</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="{{ "assets/css/main.css" | relative_url}}" />
		<noscript><link rel="stylesheet" href="{{ "assets/css/noscript.css" | relative_url }}" /></noscript>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js"></script>
		<script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.0/js/msal.js"></script>
	</head>
	<body class="is-preload">
		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					<header id="header">
						<div class="inner">

							<!-- Logo -->
								<a href="{{ "/" | relative_url}}" class="logo">
									<span class="symbol"><img src="{{ "assets/images/logo.svg" | relative_url }}" alt="" /></span><span class="title">Recipes</span>
								</a>

							<!-- Nav -->
								<nav>
									<ul>
										<li><a href="#menu">Menu</a></li>
									</ul>
								</nav>

						</div>
					</header>

				<!-- Menu -->
					<nav id="menu">
						<h2>Menu<span id="username"></span></h2>
						<ul>
							<li><a href="{{ "/" | relative_url}}">Home</a></li>
							{% for category in site.data.categories %}
							<li><a href="{{ category.name | slugify | relative_url}}">{{category.name | capitalize }}</a></li>
							{% endfor %}
							<li><a id="loginButton" href="">Login</a></li>
							<li style="display: none;" id="editButton"><a href="{{ "/edit" | relative_url }}">Edit</a></li>
							<!-- <li><a href="{{ "/recipes" | relative_url}}">Recipes</a></li> -->
							<!--<li><a href="generic.html">Tempus etiam</a></li>
							<li><a href="generic.html">Consequat dolor</a></li>
							<li><a href="elements.html">Elements</a></li> -->
						</ul>
					</nav>

				<!-- Main -->
					<div id="main">
						<div class="inner">
							<p id="json"></p>
<p id="WelcomeMessage"></p>
							<!-- <header>
								<h1>This is Phantom, a free, fully responsive site<br />
								template designed by <a href="http://html5up.net">HTML5 UP</a>.</h1>
								<p>Etiam quis viverra lorem, in semper lorem. Sed nisl arcu euismod sit amet nisi euismod sed cursus arcu elementum ipsum arcu vivamus quis venenatis orci lorem ipsum et magna feugiat veroeros aliquam. Lorem ipsum dolor sit amet nullam dolore.</p>
							</header> -->
							{{content}}
						</div>
					</div>

				<!-- Footer -->
					<!-- <footer id="footer">
						<div class="inner">
							<section>
								<h2>Get in touch</h2>
								<form method="post" action="#">
									<div class="fields">
										<div class="field half">
											<input type="text" name="name" id="name" placeholder="Name" />
										</div>
										<div class="field half">
											<input type="email" name="email" id="email" placeholder="Email" />
										</div>
										<div class="field">
											<textarea name="message" id="message" placeholder="Message"></textarea>
										</div>
									</div>
									<ul class="actions">
										<li><input type="submit" value="Send" class="primary" /></li>
									</ul>
								</form>
							</section>
							<section>
								<h2>Follow</h2>
								<ul class="icons">
									<li><a href="#" class="icon brands style2 fa-twitter"><span class="label">Twitter</span></a></li>
									<li><a href="#" class="icon brands style2 fa-facebook-f"><span class="label">Facebook</span></a></li>
									<li><a href="#" class="icon brands style2 fa-instagram"><span class="label">Instagram</span></a></li>
									<li><a href="#" class="icon brands style2 fa-dribbble"><span class="label">Dribbble</span></a></li>
									<li><a href="#" class="icon brands style2 fa-github"><span class="label">GitHub</span></a></li>
									<li><a href="#" class="icon brands style2 fa-500px"><span class="label">500px</span></a></li>
									<li><a href="#" class="icon solid style2 fa-phone"><span class="label">Phone</span></a></li>
									<li><a href="#" class="icon solid style2 fa-envelope"><span class="label">Email</span></a></li>
								</ul>
							</section>
							<ul class="copyright">
								<li>&copy; Untitled. All rights reserved</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
							</ul>
						</div>
					</footer> -->

			</div>

		<!-- Scripts -->
		<script>	
			var msalConfig = {
							auth: {
							clientId: '72b94666-c0f8-451b-a060-e48ab230c13c',
							authority: 'https://login.microsoftonline.com/8e81e7c5-f030-4a29-85be-a64c83c892b6',
							redirectUri: 'http://localhost:4000/recipes/',
							forceRefresh: true
							},
							cache: {
							// cacheLocation: 'sessionStorage',
							// storeAuthStateInCookie: true
							
							}
						};
						const loginRequest = {
					scopes: ["openid", "profile", "User.Read"]
				}
			      // Select DOM elements to work with
				  const welcomeDiv = document.getElementById("WelcomeMessage");
      const loginButton = document.getElementById("loginButton");
      const jsonPre = document.getElementById("json");
      
      const graphConfig = {
        graphMeEndpoint: "https://graph.microsoft.com/v1.0/me"
      };

      const requestObj = {
        scopes: ["user.read"]
      };

      // Create the main myMSALObj instance
	  const myMSALObj = new Msal.UserAgentApplication(msalConfig);
	  
	  //???
	  if (location.hash.includes("id_token") || location.hash.includes("access_token")) {
    open(location, '_self').close()
    window.close()
}

	  loginButton.addEventListener('click', signIn, false);

      // Register Callbacks for redirect flow
      myMSALObj.handleRedirectCallback(authRedirectCallBack);

      async function signIn() {
        try {
          await myMSALObj.loginPopup(requestObj);

		  // Login Success
		  
		  window.close()
          showWelcomeMessage();
		  acquireTokenPopupAndCallMSGraph();
        } catch (error) {
          console.error(error);
        }
      }

      async function acquireTokenPopupAndCallMSGraph() {
        let tokenResponse;
        try {
          // try and get the token silently in the background
		  tokenResponse = await myMSALObj.acquireTokenSilent(requestObj);
        } catch (error) {
          console.log(error);
          // if the silent request failed, it might be because the user
          // needs to request one interactively via a pop-up or redirect
          if (requiresInteraction(error.errorCode)) {
            try {
              // try and get the token with an interactive pop-up window
              tokenResponse = await myMSALObj.acquireTokenPopup(requestObj);
            } catch (error) {
              console.log(error);
            }
		  }
        }
        callMSGraph(
          graphConfig.graphMeEndpoint,
          tokenResponse.accessToken,
          graphAPICallback
        );
      }

      function graphAPICallback(data) {
        jsonPre.innerHTML = JSON.stringify(data, null, 2);
      }

      function showWelcomeMessage() {
        // welcomeDiv.innerHTML = `Welcome ${
        //   myMSALObj.getAccount().userName
        // } to Microsoft Graph API`;

		welcomeDiv.innerHTML = JSON.stringify(myMSALObj.getAccount());
		
		// Change the login button to log out
		loginButton.removeEventListener('click', signIn, false);
		loginButton.addEventListener('click', signOut, false);
        loginButton.innerHTML = "Sign Out";
      }

      // This function can be removed if you do not need to support IE
      async function acquireTokenRedirectAndCallMSGraph() {
        try {
          // Always start with acquireTokenSilent to obtain a token in the signed in user from cache
          const tokenResponse = myMSALObj.acquireTokenSilent(requestObj);
          callMSGraph(
            graphConfig.graphMeEndpoint,
            tokenResponse.accessToken,
            graphAPICallback
          );
        } catch (error) {
          console.log(error);
          // Upon acquireTokenSilent failure (due to consent or interaction or login required ONLY)
          // Call acquireTokenRedirect
          if (requiresInteraction(error.errorCode)) {
            myMSALObj.acquireTokenRedirect(requestObj);
          }
        }
      }

      function authRedirectCallBack(error, response) {
		//todo refresh?
        if (error) {
          console.log(error);
        } else {
          if (response.tokenType === "access_token") {
            callMSGraph(
              graphConfig.graphEndpoint,
              response.accessToken,
              graphAPICallback
            );
          } else {
            console.log("token type is: %s", 0);
		  }
		  window.location.reload(false);
		  
        }
      }

      function requiresInteraction(errorCode) {
        if (!errorCode || !errorCode.length) {
          return false;
        }
        return (
          errorCode === "consent_required" ||
          errorCode === "interaction_required" ||
          errorCode === "login_required"
        );
      }

      // Browser check variables
      const ua = window.navigator.userAgent;
      const msie = ua.indexOf("MSIE ");
      const msie11 = ua.indexOf("Trident/");
      const msedge = ua.indexOf("Edge/");
      const isIE = msie > 0 || msie11 > 0;
      const isEdge = msedge > 0;

      // If you support IE, our recommendation is that you sign-in using Redirect APIs
      // If you as a developer are testing using Edge InPrivate mode, please add "isEdge" to the if check
      // can change this to default an experience outside browser use
      const loginType = isIE ? "REDIRECT" : "POPUP";

      if (loginType === "POPUP") {
        if (myMSALObj.getAccount()) {
          // avoid duplicate code execution on page load in case of iframe and popup window.
          showWelcomeMessage();
          acquireTokenPopupAndCallMSGraph();
        }
      } else if (loginType === "REDIRECT") {
        signIn.onclick = function() {
          myMSALObj.loginRedirect(requestObj);
        };
        if (
          myMSALObj.getAccount() &&
          !myMSALObj.isCallback(window.location.hash)
        ) {
          // avoid duplicate code execution on page load in case of iframe and popup window.
          showWelcomeMessage();
          acquireTokenRedirectAndCallMSGraph();
        }
      } else {
        console.error("Please set a valid login type");
      }

      function signOut() {
        myMSALObj.logout();
      }

      async function callMSGraph(theUrl, accessToken, callback) {
        const xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function() {
          if (this.readyState === 4 && this.status === 200)
            callback(JSON.parse(this.responseText));
        };
        xmlHttp.open("GET", theUrl, true); // true for asynchronous
        xmlHttp.setRequestHeader("Authorization", `Bearer ${accessToken}`);
        xmlHttp.send();
      }
					</script>
			<script src="{{ "assets/js/jquery.min.js" | relative_url }}"></script>
			<script src="{{ "assets/js/browser.min.js" | relative_url }}"></script>
			<script src="{{ "assets/js/breakpoints.min.js" | relative_url }}"></script>
			<script src="{{ "assets/js/util.js" | relative_url }}"></script>
			<script src="{{ "assets/js/main.js" | relative_url }}"></script>

	</body>
</html>